{% extends "base.html" %}

{% block title %}Invoice {{ bill.bill_no }} - Sri Dhanalakshmi Blue Metals{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .no-print {
            display: none !important;
        }
        body {
            background: white;
        }
        .invoice-container {
            box-shadow: none;
            border: none;
        }
    }
    .invoice-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .company-header {
        text-align: center;
        border-bottom: 2px solid #1a237e;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    .company-name {
        font-size: 24px;
        font-weight: bold;
        color: #1a237e;
        margin-bottom: 10px;
    }
    .invoice-table {
        width: 100%;
        margin-top: 20px;
    }
    .invoice-table th {
        background-color: #1a237e;
        color: white;
        padding: 12px;
        text-align: center;
    }
    .invoice-table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }
    .totals-section {
        margin-top: 20px;
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="invoice-container">
    <div class="no-print mb-3">
        <a href="{% if current_user.role == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('dashboard') }}{% endif %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer"></i> Print Invoice
        </button>
        <a href="{{ url_for('invoice_pdf', bill_id=bill.id) }}" class="btn btn-success">
            <i class="bi bi-download"></i> Download PDF
        </a>
        <button onclick="shareWhatsApp()" class="btn btn-success" style="background-color: #25D366;">
            <i class="bi bi-whatsapp"></i> Share via WhatsApp
        </button>
    </div>

    <!-- Company Header (Tamil) -->
    <div class="company-header">
        <div class="company-name">{{ company_settings.company_name_tamil }}</div>
        <div style="margin-top: 10px; font-size: 14px; line-height: 1.6;">
            {{ company_settings.address_tamil|replace('\n', '<br>')|safe }}
        </div>
        <div style="margin-top: 10px; font-size: 12px;">
            <strong>GSTIN:</strong> {{ company_settings.gstin }}<br>
            <strong>மொபைல்:</strong> {{ company_settings.phone_numbers }}
        </div>
    </div>

    <!-- Invoice Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h5>Bill Details</h5>
            <p><strong>Bill Number:</strong> {{ bill.bill_no }}</p>
            <p><strong>Date:</strong> {{ bill.date.strftime('%d-%m-%Y %H:%M') }}</p>
        </div>
        <div class="col-md-6">
            <h5>Customer Details</h5>
            <p><strong>Name:</strong> {{ bill.customer.name }}</p>
            {% if bill.customer.gst_number %}
            <p><strong>GST:</strong> {{ bill.customer.gst_number }}</p>
            {% endif %}
            {% if bill.customer.phone %}
            <p><strong>Phone:</strong> {{ bill.customer.phone }}</p>
            {% endif %}
            {% if bill.customer.address %}
            <p><strong>Address:</strong> {{ bill.customer.address }}</p>
            {% endif %}
            {% if bill.vehicle %}
            <p><strong>Vehicle:</strong> {{ bill.vehicle.vehicle_number }} {% if bill.vehicle.vehicle_type %}({{ bill.vehicle.vehicle_type }}){% endif %}</p>
            {% endif %}
        </div>
    </div>

    <!-- Items Table -->
    <table class="invoice-table table table-bordered">
        <thead>
            <tr>
                <th>S.No</th>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Rate (₹)</th>
                <th>Amount (₹)</th>
                <th>GST (5%)</th>
                <th>Total (₹)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td>{{ bill.item.name }}</td>
                <td>{{ "%.2f"|format(bill.quantity) }}</td>
                <td>{{ "%.2f"|format(bill.rate) }}</td>
                <td>{{ "%.2f"|format(bill.total) }}</td>
                <td>{{ "%.2f"|format(bill.gst) }}</td>
                <td><strong>{{ "%.2f"|format(bill.grand_total) }}</strong></td>
            </tr>
        </tbody>
        <tfoot>
            <tr style="background-color: #f5f5f5;">
                <td colspan="5" style="text-align: right;"><strong>Subtotal:</strong></td>
                <td colspan="2" style="text-align: center;"><strong>₹{{ "%.2f"|format(bill.total) }}</strong></td>
            </tr>
            <tr style="background-color: #f5f5f5;">
                <td colspan="5" style="text-align: right;"><strong>GST (5%):</strong></td>
                <td colspan="2" style="text-align: center;"><strong>₹{{ "%.2f"|format(bill.gst) }}</strong></td>
            </tr>
            <tr style="background-color: #1a237e; color: white;">
                <td colspan="5" style="text-align: right;"><strong>Grand Total:</strong></td>
                <td colspan="2" style="text-align: center;"><strong>₹{{ "%.2f"|format(bill.grand_total) }}</strong></td>
            </tr>
        </tfoot>
    </table>

    <!-- Footer -->
    <div style="margin-top: 30px; text-align: center; font-size: 14px; color: #666;">
        {{ company_settings.footer_message or 'நன்றி!' }}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function shareWhatsApp() {
    const billNo = '{{ bill.bill_no }}';
    const total = '{{ bill.grand_total }}';
    const text = `Bill Number: ${billNo}\nTotal: ₹${total}\n\nView invoice: ${window.location.href}`;
    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}
