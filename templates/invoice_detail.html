{% extends "base.html" %}

{% block title %}Invoice {{ bill.bill_no }} - Sri Dhanalakshmi Blue Metals{% endblock %}

{% block extra_css %}
<style>
    .invoice-container { max-width: 900px; margin: 0 auto; background: white; color: #111827; }
    .wm-logo { position: absolute; right: 2rem; top: 2rem; opacity: .1; width: 140px; height: 140px; object-fit: contain; }
    @media print {
        body {
            background: white !important;
            color: black !important;
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
            font-family: 'Noto Sans Tamil', 'Poppins', sans-serif !important;
        }
        .no-print { display: none !important; }
        .invoice-container { box-shadow: none !important; border: none !important; }
        .wm-logo { opacity: .1 !important; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
        .overflow-x-auto { overflow-x: visible !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="invoice-container relative bg-white/70 backdrop-blur-md rounded-xl shadow-lg p-6">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="wm-logo">
    <div class="no-print mb-4 flex flex-wrap gap-2">
        <a href="{% if current_user.role == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('dashboard') }}{% endif %}" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 px-4 py-2 font-semibold text-slate-700"><i class="bi bi-arrow-left"></i> Back</a>
        <button onclick="window.print()" class="inline-flex items-center gap-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 font-semibold">
            <i class="bi bi-printer"></i> Print
        </button>
        <a href="{{ url_for('invoice_pdf', bill_id=bill.id) }}" class="inline-flex items-center gap-2 rounded-lg bg-green-600 hover:bg-green-700 text-white px-4 py-2 font-semibold">
            <i class="bi bi-download"></i> PDF
        </a>
        <button onclick="shareWhatsApp()" class="inline-flex items-center gap-2 rounded-lg bg-[#25D366] hover:opacity-90 text-white px-4 py-2 font-semibold">
            <i class="bi bi-whatsapp"></i> WhatsApp
        </button>
    </div>

    <!-- Company Header (Tamil) -->
    <div class="border-b border-slate-300 pb-4 mb-6">
        <div class="flex flex-col md:flex-row items-start gap-4">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="h-20 w-20 object-contain">
            <div class="flex-1 text-left md:text-right">
                <div class="text-2xl font-semibold text-blue-800">{{ company_settings.company_name_tamil }}</div>
                <div class="text-lg text-blue-900">{{ company_settings.company_name_english }}</div>
                <div class="text-sm mt-2" style="line-height: 1.6;">{{ company_settings.address_tamil|replace('\n', '<br>')|safe }}</div>
                <div class="text-sm mt-1"><strong>GSTIN:</strong> {{ company_settings.gstin }} &nbsp; &nbsp; <strong>üìû</strong> {{ company_settings.phone_numbers }}</div>
            </div>
        </div>
    </div>

    <!-- Invoice Details -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            <h5 class="font-semibold mb-3 text-slate-800">Bill Details</h5>
            <div class="space-y-2 text-sm">
                <p><strong class="text-slate-700">Bill No:</strong> <span class="text-slate-900">{{ bill.bill_no }}</span></p>
                <p><strong class="text-slate-700">‡Æ§‡Øá‡Æ§‡Æø / Date:</strong> <span class="text-slate-900">{{ bill.date.strftime('%d-%m-%Y %H:%M') }}</span></p>
            </div>
        </div>
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
            <h5 class="font-semibold mb-3 text-slate-800">Customer</h5>
            <div class="space-y-2 text-sm">
                <p><strong class="text-slate-700">‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç:</strong> <span class="text-slate-900">{{ bill.customer.name }}</span></p>
                {% if bill.customer.gst_number %}<p><strong class="text-slate-700">GST:</strong> <span class="text-slate-900">{{ bill.customer.gst_number }}</span></p>{% endif %}
                {% if bill.customer.phone %}<p><strong class="text-slate-700">Phone:</strong> <span class="text-slate-900">{{ bill.customer.phone }}</span></p>{% endif %}
                {% if bill.customer.address %}<p><strong class="text-slate-700">Address:</strong> <span class="text-slate-900">{{ bill.customer.address }}</span></p>{% endif %}
                {% if bill.vehicle %}<p><strong class="text-slate-700">‡Æµ‡Ææ‡Æï‡Æ© ‡Æé‡Æ£‡Øç:</strong> <span class="text-slate-900">{{ bill.vehicle.vehicle_number }} {% if bill.vehicle.vehicle_type %}({{ bill.vehicle.vehicle_type }}){% endif %}</span></p>{% endif %}
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="overflow-x-auto">
        <table class="w-full border-collapse mt-4 text-center border border-slate-300">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-3 py-2 border border-slate-300 font-semibold text-slate-800">S.No</th>
                    <th class="px-3 py-2 border border-slate-300 font-semibold text-slate-800">‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç / Item</th>
                    <th class="px-3 py-2 border border-slate-300 font-semibold text-slate-800">‡ÆÖ‡Æ≥‡Æµ‡ØÅ / Qty</th>
                    <th class="px-3 py-2 border border-slate-300 font-semibold text-slate-800">‡Æµ‡Æø‡Æ≤‡Øà / Rate</th>
                    <th class="px-3 py-2 border border-slate-300 font-semibold text-slate-800">‡Æ§‡Øä‡Æï‡Øà / Amount</th>
                    <th class="px-3 py-2 border border-slate-300 font-semibold text-slate-800">GST (5%)</th>
                    <th class="px-3 py-2 border border-slate-300 font-semibold text-slate-800">‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç / Total</th>
                </tr>
            </thead>
            <tbody class="text-center">
                <tr>
                    <td class="px-3 py-2 border border-slate-200">1</td>
                    <td class="px-3 py-2 border border-slate-200 text-left">{{ bill.item.name }}</td>
                    <td class="px-3 py-2 border border-slate-200">{{ "%.2f"|format(bill.quantity) }}</td>
                    <td class="px-3 py-2 border border-slate-200">‚Çπ{{ "%.2f"|format(bill.rate) }}</td>
                    <td class="px-3 py-2 border border-slate-200">‚Çπ{{ "%.2f"|format(bill.total) }}</td>
                    <td class="px-3 py-2 border border-slate-200">‚Çπ{{ "%.2f"|format(bill.gst) }}</td>
                    <td class="px-3 py-2 border border-slate-200 font-semibold">‚Çπ{{ "%.2f"|format(bill.grand_total) }}</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="bg-slate-50">
                    <td colspan="5" class="px-3 py-2 text-right border border-slate-300 font-semibold text-slate-800">Subtotal:</td>
                    <td colspan="2" class="px-3 py-2 text-center border border-slate-300 font-semibold text-slate-900">‚Çπ{{ "%.2f"|format(bill.total) }}</td>
                </tr>
                <tr class="bg-slate-50">
                    <td colspan="5" class="px-3 py-2 text-right border border-slate-300 font-semibold text-slate-800">GST (5%):</td>
                    <td colspan="2" class="px-3 py-2 text-center border border-slate-300 font-semibold text-slate-900">‚Çπ{{ "%.2f"|format(bill.gst) }}</td>
                </tr>
                <tr class="bg-blue-600 text-white">
                    <td colspan="5" class="px-3 py-2 text-right border border-slate-300 font-bold">Grand Total:</td>
                    <td colspan="2" class="px-3 py-2 text-center border border-slate-300 font-bold text-lg">‚Çπ{{ "%.2f"|format(bill.grand_total) }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Footer -->
    <div class="mt-6 text-center text-slate-700 font-semibold">{{ company_settings.footer_message or '‡Æ®‡Æ©‡Øç‡Æ±‡Æø!' }}</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function shareWhatsApp() {
    const billNo = '{{ bill.bill_no }}';
    const total = '{{ bill.grand_total }}';
    const text = `Bill Number: ${billNo}\nTotal: ‚Çπ${total}\n\nView invoice: ${window.location.href}`;
    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}
