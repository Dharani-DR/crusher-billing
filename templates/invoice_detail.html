{% extends "base.html" %}

{% block title %}Invoice {{ bill.bill_no }} - Sri Dhanalakshmi Blue Metals{% endblock %}

{% block extra_css %}
<style>
    .invoice-container { max-width: 900px; margin: 0 auto; background: white; color: #111827; }
    .wm-logo { position: absolute; right: 2rem; top: 2rem; opacity: .1; width: 140px; height: 140px; object-fit: contain; }
    @media print {
        .no-print { display: none !important; }
        .invoice-container { box-shadow: none !important; border: none !important; }
        .wm-logo { opacity: .1 !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="invoice-container relative glass p-6">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="wm-logo">
    <div class="no-print mb-3 flex gap-2">
        <a href="{% if current_user.role == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('dashboard') }}{% endif %}" class="inline-flex items-center gap-2 rounded-md border border-slate-300 px-3 py-2"><i class="bi bi-arrow-left"></i> Back</a>
        <button onclick="window.print()" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2">
            <i class="bi bi-printer"></i> Print
        </button>
        <a href="{{ url_for('invoice_pdf', bill_id=bill.id) }}" class="inline-flex items-center gap-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2">
            <i class="bi bi-download"></i> PDF
        </a>
        <button onclick="shareWhatsApp()" class="inline-flex items-center gap-2 rounded-md bg-[#25D366] hover:opacity-90 text-white px-3 py-2">
            <i class="bi bi-whatsapp"></i> WhatsApp
        </button>
    </div>

    <!-- Company Header (Tamil) -->
    <div class="border-b border-slate-300 pb-4 mb-4">
        <div class="flex items-start gap-4">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="h-20 w-20 object-contain">
            <div class="flex-1 text-right">
                <div class="text-2xl font-semibold text-indigo-800">{{ company_settings.company_name_tamil }}</div>
                <div class="text-lg text-indigo-900">{{ company_settings.company_name_english }}</div>
                <div class="text-sm mt-2" style="line-height: 1.6;">{{ company_settings.address_tamil|replace('\n', '<br>')|safe }}</div>
                <div class="text-sm mt-1"><strong>GSTIN:</strong> {{ company_settings.gstin }} &nbsp; &nbsp; <strong>üìû</strong> {{ company_settings.phone_numbers }}</div>
            </div>
        </div>
    </div>

    <!-- Invoice Details -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="glass p-3">
            <h5 class="font-semibold mb-2">Bill Details</h5>
            <p><strong>Bill No:</strong> {{ bill.bill_no }}</p>
            <p><strong>‡Æ§‡Øá‡Æ§‡Æø / Date:</strong> {{ bill.date.strftime('%d-%m-%Y %H:%M') }}</p>
        </div>
        <div class="glass p-3">
            <h5 class="font-semibold mb-2">Customer</h5>
            <p><strong>‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç:</strong> {{ bill.customer.name }}</p>
            {% if bill.customer.gst_number %}<p><strong>GST:</strong> {{ bill.customer.gst_number }}</p>{% endif %}
            {% if bill.customer.phone %}<p><strong>Phone:</strong> {{ bill.customer.phone }}</p>{% endif %}
            {% if bill.customer.address %}<p><strong>Address:</strong> {{ bill.customer.address }}</p>{% endif %}
            {% if bill.vehicle %}<p><strong>‡Æµ‡Ææ‡Æï‡Æ© ‡Æé‡Æ£‡Øç:</strong> {{ bill.vehicle.vehicle_number }} {% if bill.vehicle.vehicle_type %}({{ bill.vehicle.vehicle_type }}){% endif %}</p>{% endif %}
        </div>
    </div>

    <!-- Items Table -->
    <div class="glass-scroll">
        <table class="min-w-full border border-slate-300">
            <thead>
                <tr class="bg-indigo-900 text-white text-center">
                    <th class="px-3 py-2 border border-slate-300">S.No</th>
                    <th class="px-3 py-2 border border-slate-300">‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç (Item)</th>
                    <th class="px-3 py-2 border border-slate-300">‡ÆÖ‡Æ≥‡Æµ‡ØÅ (Qty)</th>
                    <th class="px-3 py-2 border border-slate-300">‡Æµ‡Æø‡Æ≤‡Øà (Rate)</th>
                    <th class="px-3 py-2 border border-slate-300">‡Æ§‡Øä‡Æï‡Øà (Amount)</th>
                    <th class="px-3 py-2 border border-slate-300">GST (5%)</th>
                    <th class="px-3 py-2 border border-slate-300">‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç (Total)</th>
                </tr>
            </thead>
            <tbody class="text-center">
                <tr>
                    <td class="px-3 py-2 border border-slate-200">1</td>
                    <td class="px-3 py-2 border border-slate-200 text-left">{{ bill.item.name }}</td>
                    <td class="px-3 py-2 border border-slate-200">{{ "%.2f"|format(bill.quantity) }}</td>
                    <td class="px-3 py-2 border border-slate-200">‚Çπ{{ "%.2f"|format(bill.rate) }}</td>
                    <td class="px-3 py-2 border border-slate-200">‚Çπ{{ "%.2f"|format(bill.total) }}</td>
                    <td class="px-3 py-2 border border-slate-200">‚Çπ{{ "%.2f"|format(bill.gst) }}</td>
                    <td class="px-3 py-2 border border-slate-200 font-semibold">‚Çπ{{ "%.2f"|format(bill.grand_total) }}</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="bg-slate-50">
                    <td colspan="5" class="px-3 py-2 text-right border border-slate-300"><strong>Subtotal:</strong></td>
                    <td colspan="2" class="px-3 py-2 text-center border border-slate-300"><strong>‚Çπ{{ "%.2f"|format(bill.total) }}</strong></td>
                </tr>
                <tr class="bg-slate-50">
                    <td colspan="5" class="px-3 py-2 text-right border border-slate-300"><strong>GST (5%):</strong></td>
                    <td colspan="2" class="px-3 py-2 text-center border border-slate-300"><strong>‚Çπ{{ "%.2f"|format(bill.gst) }}</strong></td>
                </tr>
                <tr class="bg-indigo-900 text-white">
                    <td colspan="5" class="px-3 py-2 text-right border border-slate-300"><strong>Grand Total:</strong></td>
                    <td colspan="2" class="px-3 py-2 text-center border border-slate-300"><strong>‚Çπ{{ "%.2f"|format(bill.grand_total) }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Footer -->
    <div class="mt-6 text-center text-slate-600">{{ company_settings.footer_message or '‡Æ®‡Æ©‡Øç‡Æ±‡Æø!' }}</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function shareWhatsApp() {
    const billNo = '{{ bill.bill_no }}';
    const total = '{{ bill.grand_total }}';
    const text = `Bill Number: ${billNo}\nTotal: ‚Çπ${total}\n\nView invoice: ${window.location.href}`;
    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}
