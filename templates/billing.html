{% extends "base.html" %}

{% block title %}Billing - Sri Dhanalakshmi Blue Metals{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="text-2xl font-semibold flex items-center gap-2"><i class="bi bi-receipt"></i> <span>பில் உருவாக்கு / Create New Bill</span></h2>
</div>

<form method="POST" action="{{ url_for('billing') }}" id="billingForm" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
	<input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
	<div class="space-y-4">
		<div class="glass p-4">
			<h5 class="mb-4 flex items-center gap-2"><i class="bi bi-person"></i> <span>வாடிக்கையாளர் / Customer</span></h5>
			<div class="mb-3 relative">
				<label class="block text-sm mb-1">வாடிக்கையாளர் பெயர் (Customer Name) <span class="text-rose-400">*</span></label>
				<input type="text" class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="customer_name" id="customer_name" required autocomplete="off">
				<div id="customerSuggestions" class="absolute z-50 bg-white text-slate-900 rounded-md shadow-lg mt-1 w-full max-h-56 overflow-auto hidden"></div>
			</div>
			<div class="mb-3">
				<label class="block text-sm mb-1">GST Number</label>
				<input type="text" class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="customer_gst" id="customer_gst" autocomplete="off">
			</div>
			<div class="mb-3">
				<label class="block text-sm mb-1">Phone</label>
				<input type="text" class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="customer_phone" id="customer_phone" autocomplete="off">
			</div>
			<div class="mb-1">
				<label class="block text-sm mb-1">Address</label>
				<textarea class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="customer_address" id="customer_address" rows="2"></textarea>
			</div>
		</div>

		<div class="glass p-4">
			<h5 class="mb-4 flex items-center gap-2"><i class="bi bi-truck"></i> <span>வாகனம் / Vehicle</span></h5>
			<div class="mb-3 relative">
				<label class="block text-sm mb-1">வாகன எண் (Vehicle Number) <span class="text-rose-400">*</span></label>
				<input type="text" class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="vehicle_number" id="vehicle_number" autocomplete="off" required placeholder="TN32AX3344">
				<div id="vehicleSuggestions" class="absolute z-50 bg-white text-slate-900 rounded-md shadow-lg mt-1 w-full max-h-56 overflow-auto hidden"></div>
				<div class="text-xs text-slate-300 mt-1">Format: TN32AX3344</div>
			</div>
			<div>
				<label class="block text-sm mb-1">Vehicle Type</label>
				<input type="text" class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="vehicle_type" id="vehicle_type" placeholder="Truck, Lorry" autocomplete="off">
			</div>
		</div>
	</div>

	<div class="space-y-4">
		<div class="glass p-4">
			<h5 class="mb-4 flex items-center gap-2"><i class="bi bi-box"></i> <span>பொருள் / Item</span></h5>
			<div class="mb-3">
				<label class="block text-sm mb-1">பொருள் (Item) <span class="text-rose-400">*</span></label>
				<select class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="item_id" id="item_id" required>
					<option value="">Select Item...</option>
					{% for item in items %}
					<option value="{{ item.id }}" data-rate="{{ item.rate }}">{{ item.name }} - ₹{{ item.rate }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="mb-3">
				<label class="block text-sm mb-1">அளவு (Qty) <span class="text-rose-400">*</span></label>
				<input type="number" step="0.01" min="0.01" class="w-full rounded-md bg-white/10 border border-white/10 px-4 py-2" name="quantity" id="quantity" required>
			</div>
			<div class="mb-3">
				<label class="block text-sm mb-1">விலை (Rate ₹) <span class="text-rose-400">*</span></label>
				<div class="flex gap-2">
					<input type="number" step="0.01" min="0" class="flex-1 rounded-md bg-white/10 border border-white/10 px-4 py-2" name="rate" id="rate" required>
					<button type="button" class="rounded-md border border-white/10 px-4 py-2 hover:bg-white/10" id="suggestRateBtn" title="Suggest rate from last 3 bills"><i class="bi bi-lightbulb"></i> Suggest</button>
				</div>
			</div>
		</div>

		<div class="glass p-4">
			<h5 class="mb-4 flex items-center gap-2"><i class="bi bi-calculator"></i> <span>கணக்கீடு / Summary</span></h5>
			<div class="space-y-2 text-sm">
				<div class="flex items-center justify-between"><span>Subtotal:</span><strong id="subtotal">₹0.00</strong></div>
				<div class="flex items-center justify-between"><span>CGST 2.5% + SGST 2.5%:</span><span id="gst">₹0.00</span></div>
				<div class="flex items-center justify-between gap-3">
					<span>Round-off:</span>
					<input type="number" step="0.01" class="w-32 rounded-md bg-white/10 border border-white/10 px-3 py-2 text-right" name="round_off" id="round_off" value="0">
				</div>
				<div class="flex items-center justify-between text-lg pt-2 border-t border-white/10"><span><strong>Grand Total:</strong></span><strong id="grandTotal">₹0.00</strong></div>
			</div>
		</div>
	</div>

	<div class="lg:col-span-2 action-bar glass p-3 flex gap-2 justify-end">
		<button type="submit" class="inline-flex items-center gap-2 rounded-md bg-emerald-600 hover:bg-emerald-700 px-5 py-2.5"><i class="bi bi-check-circle"></i> Save / சேமி</button>
		<a href="{% if current_user.role == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('dashboard') }}{% endif %}" class="inline-flex items-center gap-2 rounded-md border border-white/10 px-5 py-2.5 hover:bg-white/10"><i class="bi bi-x-circle"></i> Cancel</a>
	</div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerNameInput = document.getElementById('customer_name');
    const customerGstInput = document.getElementById('customer_gst');
    const customerPhoneInput = document.getElementById('customer_phone');
    const customerAddressInput = document.getElementById('customer_address');
    const customerSuggestions = document.getElementById('customerSuggestions');
    const itemSelect = document.getElementById('item_id');
    const quantityInput = document.getElementById('quantity');
    const rateInput = document.getElementById('rate');
    const roundOffInput = document.getElementById('round_off');
    const suggestRateBtn = document.getElementById('suggestRateBtn');
    const vehicleInput = document.getElementById('vehicle_number');
    const vehicleTypeInput = document.getElementById('vehicle_type');
    const vehicleSuggestions = document.getElementById('vehicleSuggestions');
    
    let customerSearchTimeout;
    
    // Customer autocomplete
    customerNameInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            customerSuggestions.style.display = 'none';
            return;
        }
        
        clearTimeout(customerSearchTimeout);
        customerSearchTimeout = setTimeout(() => {
            fetch(`{{ url_for('api_customers_search') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        customerSuggestions.innerHTML = '';
                        data.forEach(customer => {
                            const div = document.createElement('div');
                            div.className = 'px-3 py-2 hover:bg-slate-100 cursor-pointer';
                            div.textContent = customer.name;
                            div.addEventListener('click', function() {
                                customerNameInput.value = customer.name;
                                customerGstInput.value = customer.gst_number || '';
                                customerPhoneInput.value = customer.phone || '';
                                customerAddressInput.value = customer.address || '';
                                customerSuggestions.style.display = 'none';
                            });
                            customerSuggestions.appendChild(div);
                        });
                        customerSuggestions.style.display = 'block';
                    } else {
                        customerSuggestions.style.display = 'none';
                    }
                });
        }, 300);
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!customerNameInput.contains(e.target) && !customerSuggestions.contains(e.target)) {
            customerSuggestions.style.display = 'none';
        }
        if (!vehicleInput.contains(e.target) && !vehicleSuggestions.contains(e.target)) {
            vehicleSuggestions.style.display = 'none';
        }
    });
    
    // Auto-fill rate when item is selected
    itemSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const rate = parseFloat(selectedOption.dataset.rate);
            rateInput.value = rate.toFixed(2);
            calculateTotals();
        }
    });
    
    // Suggest rate button
    suggestRateBtn.addEventListener('click', function() {
        const itemId = itemSelect.value;
        if (!itemId) {
            alert('Please select an item first');
            return;
        }
        
        fetch(`{{ url_for('api_suggest_rate', item_id=0) }}`.replace('0', itemId))
            .then(response => response.json())
            .then(data => {
                if (data.suggested_rate) {
                    rateInput.value = data.suggested_rate.toFixed(2);
                    calculateTotals();
                } else {
                    alert('No previous bills found for this item');
                }
            });
    });
    
    // Calculate totals
    function calculateTotals() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const roundOff = parseFloat(roundOffInput.value) || 0;
        
        const subtotal = quantity * rate;
        const gst = subtotal * 0.05; // 5% GST (2.5% + 2.5%)
        const grandTotal = subtotal + gst + roundOff;
        
        document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
        document.getElementById('gst').textContent = '₹' + gst.toFixed(2);
        document.getElementById('grandTotal').textContent = '₹' + grandTotal.toFixed(2);
    }
    
    quantityInput.addEventListener('input', calculateTotals);
    rateInput.addEventListener('input', calculateTotals);
    roundOffInput.addEventListener('input', calculateTotals);
    
    // Initial calculation
    calculateTotals();

    // Vehicle autocomplete + uppercase + regex validate
    function validateVehicleFormat(value) {
        return /^[A-Z]{2}\d{2}[A-Z]{1,2}\d{4}$/.test(value);
    }

    vehicleInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/\s+/g, '');
        const query = this.value.trim();
        if (query.length < 2) {
            vehicleSuggestions.style.display = 'none';
            return;
        }
        fetch(`/api/vehicles?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(list => {
                vehicleSuggestions.innerHTML = '';
                list.forEach(v => {
                    const div = document.createElement('div');
                    div.className = 'px-3 py-2 hover:bg-slate-100 cursor-pointer';
                    div.textContent = `${v.vehicle_number}${v.vehicle_type ? ' ('+v.vehicle_type+')' : ''}`;
                    div.addEventListener('click', () => {
                        vehicleInput.value = v.vehicle_number;
                        vehicleTypeInput.value = v.vehicle_type || '';
                        vehicleSuggestions.style.display = 'none';
                    });
                    vehicleSuggestions.appendChild(div);
                });
                vehicleSuggestions.style.display = list.length ? 'block' : 'none';
            });
    });

    // On submit validate vehicle format
    document.getElementById('billingForm').addEventListener('submit', function(e) {
        const v = vehicleInput.value.toUpperCase().trim();
        if (!validateVehicleFormat(v)) {
            e.preventDefault();
            alert('Invalid vehicle number. Expected format like TN32AX3344');
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e){
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); document.getElementById('billingForm').requestSubmit(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p') { e.preventDefault(); const link = document.querySelector('[data-download-pdf]'); if (link) link.click(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'r') { e.preventDefault(); document.getElementById('billingForm').reset(); calculateTotals(); }
    });
});
</script>
{% endblock %}

