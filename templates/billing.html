{% extends "layout.html" %}

{% block title %}Billing - Crusher Billing{% endblock %}

{% block content %}
<div class="space-y-3">
  <h2 class="text-xl font-bold text-gray-800 mb-2">பில் உருவாக்கு / Create New Bill</h2>
  
  <form method="POST" action="{{ url_for('billing') }}" id="billingForm" class="space-y-3">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="relative">
        <label class="block font-semibold text-sm mb-1">வாடிக்கையாளர் பெயர் / Customer Name <span class="text-red-500">*</span></label>
        <input type="text" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="customer_name" id="customer_name" required autocomplete="off">
        <div id="customerSuggestions" class="absolute z-50 bg-white text-gray-900 rounded-md shadow-lg mt-1 w-full max-h-48 overflow-auto hidden border border-gray-200"></div>
      </div>
      
      <div class="relative">
        <label class="block font-semibold text-sm mb-1">வாகன எண் / Vehicle No <span class="text-red-500">*</span></label>
        <input type="text" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400 uppercase" name="vehicle_number" id="vehicle_number" required autocomplete="off" placeholder="TN32AX3344">
        <div id="vehicleSuggestions" class="absolute z-50 bg-white text-gray-900 rounded-md shadow-lg mt-1 w-full max-h-48 overflow-auto hidden border border-gray-200"></div>
        <div class="text-xs text-gray-500 mt-1">Format: TN32AX3344</div>
      </div>
      
      <div>
        <label class="block font-semibold text-sm mb-1">GST Number</label>
        <input type="text" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="customer_gst" id="customer_gst" autocomplete="off">
      </div>
      
      <div>
        <label class="block font-semibold text-sm mb-1">Phone</label>
        <input type="text" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="customer_phone" id="customer_phone" autocomplete="off">
      </div>
      
      <div>
        <label class="block font-semibold text-sm mb-1">Vehicle Type</label>
        <input type="text" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="vehicle_type" id="vehicle_type" placeholder="Truck, Lorry" autocomplete="off">
      </div>
      
      <div class="md:col-span-2">
        <label class="block font-semibold text-sm mb-1">Address</label>
        <textarea class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="customer_address" id="customer_address" rows="2"></textarea>
      </div>
      
      <div>
        <label class="block font-semibold text-sm mb-1">பொருள் / Item <span class="text-red-500">*</span></label>
        <select class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="item_id" id="item_id" required>
          <option value="">Select Item...</option>
          {% for item in items %}
          <option value="{{ item.id }}" data-rate="{{ item.rate }}">{{ item.name }} - ₹{{ item.rate }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div>
        <label class="block font-semibold text-sm mb-1">அளவு / Qty <span class="text-red-500">*</span></label>
        <input type="number" step="0.01" min="0.01" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="quantity" id="quantity" required>
      </div>
      
      <div>
        <label class="block font-semibold text-sm mb-1">விலை / Rate ₹ <span class="text-red-500">*</span></label>
        <div class="flex gap-2">
          <input type="number" step="0.01" min="0" class="flex-1 border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="rate" id="rate" required>
          <button type="button" class="bg-blue-100 hover:bg-blue-200 text-blue-700 border border-blue-300 rounded-md px-3 py-2 text-sm font-semibold" id="suggestRateBtn" title="Suggest rate"><i class="bi bi-lightbulb"></i></button>
        </div>
      </div>
      
      <div>
        <label class="block font-semibold text-sm mb-1">Round-off</label>
        <input type="number" step="0.01" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-400" name="round_off" id="round_off" value="0">
      </div>
    </div>
    
    <div class="bg-gray-50 rounded-md p-3 border border-gray-200">
      <div class="flex items-center justify-between text-sm mb-1">
        <span class="text-gray-700">Subtotal:</span>
        <strong class="text-gray-900" id="subtotal">₹0.00</strong>
      </div>
      <div class="flex items-center justify-between text-sm mb-1">
        <span class="text-gray-700">CGST 2.5% + SGST 2.5%:</span>
        <span class="text-gray-900" id="gst">₹0.00</span>
      </div>
      <div class="flex items-center justify-between text-base pt-2 border-t border-gray-300">
        <span class="font-semibold text-gray-800">Grand Total:</span>
        <strong class="text-blue-600 text-lg" id="grandTotal">₹0.00</strong>
      </div>
    </div>
    
    <div class="flex flex-col md:flex-row gap-3 mt-3">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg text-sm">Generate Bill / பில் உருவாக்கு</button>
      <a href="{% if current_user.role == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('dashboard') }}{% endif %}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg text-sm text-center">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerNameInput = document.getElementById('customer_name');
    const customerGstInput = document.getElementById('customer_gst');
    const customerPhoneInput = document.getElementById('customer_phone');
    const customerAddressInput = document.getElementById('customer_address');
    const customerSuggestions = document.getElementById('customerSuggestions');
    const itemSelect = document.getElementById('item_id');
    const quantityInput = document.getElementById('quantity');
    const rateInput = document.getElementById('rate');
    const roundOffInput = document.getElementById('round_off');
    const suggestRateBtn = document.getElementById('suggestRateBtn');
    const vehicleInput = document.getElementById('vehicle_number');
    const vehicleTypeInput = document.getElementById('vehicle_type');
    const vehicleSuggestions = document.getElementById('vehicleSuggestions');
    
    let customerSearchTimeout;
    
    customerNameInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            customerSuggestions.style.display = 'none';
            return;
        }
        clearTimeout(customerSearchTimeout);
        customerSearchTimeout = setTimeout(() => {
            fetch(`{{ url_for('api_customers_search') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        customerSuggestions.innerHTML = '';
                        data.forEach(customer => {
                            const div = document.createElement('div');
                            div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                            div.textContent = customer.name;
                            div.addEventListener('click', function() {
                                customerNameInput.value = customer.name;
                                customerGstInput.value = customer.gst_number || '';
                                customerPhoneInput.value = customer.phone || '';
                                customerAddressInput.value = customer.address || '';
                                customerSuggestions.style.display = 'none';
                            });
                            customerSuggestions.appendChild(div);
                        });
                        customerSuggestions.style.display = 'block';
                    } else {
                        customerSuggestions.style.display = 'none';
                    }
                });
        }, 300);
    });
    
    document.addEventListener('click', function(e) {
        if (!customerNameInput.contains(e.target) && !customerSuggestions.contains(e.target)) {
            customerSuggestions.style.display = 'none';
        }
        if (!vehicleInput.contains(e.target) && !vehicleSuggestions.contains(e.target)) {
            vehicleSuggestions.style.display = 'none';
        }
    });
    
    itemSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const rate = parseFloat(selectedOption.dataset.rate);
            rateInput.value = rate.toFixed(2);
            calculateTotals();
        }
    });
    
    suggestRateBtn.addEventListener('click', function() {
        const itemId = itemSelect.value;
        if (!itemId) {
            alert('Please select an item first');
            return;
        }
        fetch(`{{ url_for('api_suggest_rate', item_id=0) }}`.replace('0', itemId))
            .then(response => response.json())
            .then(data => {
                if (data.suggested_rate) {
                    rateInput.value = data.suggested_rate.toFixed(2);
                    calculateTotals();
                } else {
                    alert('No previous bills found for this item');
                }
            });
    });
    
    function calculateTotals() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const roundOff = parseFloat(roundOffInput.value) || 0;
        const subtotal = quantity * rate;
        const gst = subtotal * 0.05;
        const grandTotal = subtotal + gst + roundOff;
        document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
        document.getElementById('gst').textContent = '₹' + gst.toFixed(2);
        document.getElementById('grandTotal').textContent = '₹' + grandTotal.toFixed(2);
    }
    
    quantityInput.addEventListener('input', calculateTotals);
    rateInput.addEventListener('input', calculateTotals);
    roundOffInput.addEventListener('input', calculateTotals);
    calculateTotals();

    function validateVehicleFormat(value) {
        return /^[A-Z]{2}\d{2}[A-Z]{1,2}\d{4}$/.test(value);
    }

    vehicleInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/\s+/g, '');
        const query = this.value.trim();
        if (query.length < 2) {
            vehicleSuggestions.style.display = 'none';
            return;
        }
        fetch(`/api/vehicles?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(list => {
                vehicleSuggestions.innerHTML = '';
                list.forEach(v => {
                    const div = document.createElement('div');
                    div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    div.textContent = `${v.vehicle_number}${v.vehicle_type ? ' ('+v.vehicle_type+')' : ''}`;
                    div.addEventListener('click', () => {
                        vehicleInput.value = v.vehicle_number;
                        vehicleTypeInput.value = v.vehicle_type || '';
                        vehicleSuggestions.style.display = 'none';
                    });
                    vehicleSuggestions.appendChild(div);
                });
                vehicleSuggestions.style.display = list.length ? 'block' : 'none';
            });
    });

    document.getElementById('billingForm').addEventListener('submit', function(e) {
        const v = vehicleInput.value.toUpperCase().trim();
        if (!validateVehicleFormat(v)) {
            e.preventDefault();
            alert('Invalid vehicle number. Expected format like TN32AX3344');
        }
    });
});
</script>
{% endblock %}
