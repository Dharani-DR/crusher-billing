{% extends "base.html" %}

{% block title %}Dashboard - Crusher Billing System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div class="glass p-4 flex items-center justify-between">
        <div>
            <div class="text-slate-300 text-sm">Total Bills</div>
            <div class="text-3xl font-semibold">{{ total_bills }}</div>
        </div>
        <i class="bi bi-receipt text-2xl"></i>
    </div>
    <div class="glass p-4 flex items-center justify-between">
        <div>
            <div class="text-slate-300 text-sm">Total Sales</div>
            <div class="text-3xl font-semibold">₹{{ "%.2f"|format(total_sales) }}</div>
        </div>
        <i class="bi bi-currency-rupee text-2xl"></i>
    </div>
    <div class="glass p-4 flex items-center justify-between">
        <div>
            <div class="text-slate-300 text-sm">User</div>
            <div class="text-xl font-semibold">{{ current_user.username }}</div>
        </div>
        <i class="bi bi-person-circle text-2xl"></i>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2 glass p-0">
        <div class="flex items-center justify-between p-3 border-b border-white/10">
            <h5 class="m-0 flex items-center gap-2"><i class="bi bi-clock-history"></i> Recent Bills</h5>
            <input type="search" class="rounded-md bg-white/10 border border-white/10 px-3 py-1.5 text-sm" id="recentSearch" placeholder="Search...">
        </div>
        <div class="p-3">
            {% if recent_bills %}
            <div class="glass-scroll">
                <table class="min-w-full text-sm" id="recentTable">
                    <thead class="text-left border-b border-white/10">
                        <tr>
                            <th class="px-2 py-2">Bill No</th>
                            <th class="px-2 py-2">Date</th>
                            <th class="px-2 py-2">Customer</th>
                            <th class="px-2 py-2">Item</th>
                            <th class="px-2 py-2">Total</th>
                            <th class="px-2 py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bill in recent_bills %}
                        <tr class="border-b border-white/5">
                            <td class="px-2 py-2">{{ bill.bill_no }}</td>
                            <td class="px-2 py-2">{{ bill.date.strftime('%d-%m-%Y %H:%M') }}</td>
                            <td class="px-2 py-2">{{ bill.customer.name }}</td>
                            <td class="px-2 py-2">{{ bill.item.name }}</td>
                            <td class="px-2 py-2">₹{{ "%.2f"|format(bill.grand_total) }}</td>
                            <td class="px-2 py-2"><a href="{{ url_for('invoice_detail', bill_id=bill.id) }}" class="inline-flex items-center gap-1 rounded-md bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 text-xs"><i class="bi bi-eye"></i> View</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-slate-300">No bills yet. <a href="{{ url_for('billing') }}" class="underline">Create your first bill</a></p>
            {% endif %}
        </div>
    </div>
    <div class="glass p-3">
        <h5 class="m-0 mb-2"><i class="bi bi-graph-up"></i> Sales Trend</h5>
        <canvas id="salesChart"></canvas>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const q = document.getElementById('recentSearch');
  const table = document.getElementById('recentTable');
  if (q && table) {
    q.addEventListener('input', () => {
      const term = q.value.toLowerCase();
      table.querySelectorAll('tbody tr').forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    });
  }
  const ctx = document.getElementById('salesChart');
  if (ctx && window.Chart) {
    new Chart(ctx, { type: 'bar', data: { labels: ['D-6','D-5','D-4','D-3','D-2','D-1','Today'], datasets: [{ label: 'Sales', data: [0,0,0,0,0,0,0], backgroundColor: 'rgba(230,57,70,0.6)'}] }, options: { plugins: {legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
  }
});
</script>
{% endblock %}
{% endblock %}

