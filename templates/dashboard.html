{% extends "base.html" %}

{% block title %}Dashboard - Crusher Billing System{% endblock %}

{% block content %}
<div class="row g-3 mb-3">
    <div class="col-12 col-lg-4">
        <div class="card stat-card shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted">Total Bills</div>
                    <div class="fs-2 fw-semibold">{{ total_bills }}</div>
                </div>
                <div class="stat-icon bg-primary-subtle text-primary"><i class="bi bi-receipt fs-3"></i></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card stat-card shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted">Total Sales</div>
                    <div class="fs-2 fw-semibold">₹{{ "%.2f"|format(total_sales) }}</div>
                </div>
                <div class="stat-icon bg-success-subtle text-success"><i class="bi bi-currency-rupee fs-3"></i></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card stat-card shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted">User</div>
                    <div class="fs-4 fw-semibold">{{ current_user.username }}</div>
                </div>
                <div class="stat-icon bg-info-subtle text-info"><i class="bi bi-person-circle fs-3"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="m-0"><i class="bi bi-clock-history"></i> Recent Bills</h5>
                <input type="search" class="form-control form-control-sm" id="recentSearch" placeholder="Search...">
            </div>
            <div class="card-body">
                {% if recent_bills %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="recentTable">
                        <thead>
                            <tr>
                                <th>Bill No</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Item</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bill in recent_bills %}
                            <tr>
                                <td>{{ bill.bill_no }}</td>
                                <td>{{ bill.date.strftime('%d-%m-%Y %H:%M') }}</td>
                                <td>{{ bill.customer.name }}</td>
                                <td>{{ bill.item.name }}</td>
                                <td>₹{{ "%.2f"|format(bill.grand_total) }}</td>
                                <td><a href="{{ url_for('invoice_detail', bill_id=bill.id) }}" class="btn btn-sm btn-primary rounded-pill"><i class="bi bi-eye"></i></a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No bills yet. <a href="{{ url_for('billing') }}">Create your first bill</a></p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="m-0"><i class="bi bi-graph-up"></i> Sales Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const q = document.getElementById('recentSearch');
  const table = document.getElementById('recentTable');
  if (q && table) {
    q.addEventListener('input', () => {
      const term = q.value.toLowerCase();
      table.querySelectorAll('tbody tr').forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    });
  }
  const ctx = document.getElementById('salesChart');
  if (ctx && window.Chart) {
    new Chart(ctx, { type: 'bar', data: { labels: ['D-6','D-5','D-4','D-3','D-2','D-1','Today'], datasets: [{ label: 'Sales', data: [0,0,0,0,0,0,0], backgroundColor: 'rgba(230,57,70,0.6)'}] }, options: { plugins: {legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
  }
});
</script>
{% endblock %}
{% endblock %}

