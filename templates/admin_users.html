{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <h1 class="text-2xl font-bold text-gray-800">Manage Users</h1>
    <a href="{{ url_for('admin_panel') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg text-sm">Back to Admin Panel</a>
  </div>

  <!-- Add User Form -->
  <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Add New User</h2>
    <form method="POST" action="{{ url_for('admin_add_user') }}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Username <span class="text-red-500">*</span></label>
        <input type="text" name="username" required class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
        <input type="email" name="email" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
        <input type="text" name="name" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Password <span class="text-red-500">*</span></label>
        <input type="password" name="password" required class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Role <span class="text-red-500">*</span></label>
        <select name="role" required class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <option value="user">User</option>
          <option value="staff">Staff</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Customer (for User role)</label>
        <select name="customer_id" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <option value="">None</option>
          {% for customer in customers %}
          <option value="{{ customer.id }}">{{ customer.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="md:col-span-2">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg">Add User</button>
      </div>
    </form>
  </div>

  <!-- Users List -->
  <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">All Users</h2>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border border-gray-200">ID</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border border-gray-200">Username</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border border-gray-200">Email</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border border-gray-200">Name</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border border-gray-200">Role</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border border-gray-200">Status</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border border-gray-200">Last Login</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border border-gray-200">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td class="px-4 py-3 border border-gray-200">{{ user.id }}</td>
            <td class="px-4 py-3 border border-gray-200 font-semibold">{{ user.username }}</td>
            <td class="px-4 py-3 border border-gray-200">{{ user.email or '-' }}</td>
            <td class="px-4 py-3 border border-gray-200">{{ user.name or '-' }}</td>
            <td class="px-4 py-3 border border-gray-200">
              <span class="px-2 py-1 rounded text-xs font-semibold {% if user.role == 'admin' %}bg-red-100 text-red-800{% elif user.role == 'staff' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ user.role }}
              </span>
            </td>
            <td class="px-4 py-3 border border-gray-200">
              <span class="px-2 py-1 rounded text-xs font-semibold {% if user.status == 'active' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                {{ user.status }}
              </span>
            </td>
            <td class="px-4 py-3 border border-gray-200 text-sm">{{ user.last_login.strftime('%d-%m-%Y %H:%M') if user.last_login else '-' }}</td>
            <td class="px-4 py-3 border border-gray-200 text-center">
              <button onclick="editUser({{ user.id }}, '{{ user.username }}', '{{ user.email or '' }}', '{{ user.name or '' }}', '{{ user.role }}', '{{ user.status }}', {{ user.customer_id or 'null' }})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">Edit</button>
              {% if user.id != current_user.id %}
              <form method="POST" action="{{ url_for('admin_delete_user', user_id=user.id) }}" class="inline" onsubmit="return confirm('Are you sure you want to delete this user?');">
                <button type="submit" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Edit User</h2>
    <form method="POST" id="editForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
          <input type="email" name="email" id="edit_email" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
          <input type="text" name="name" id="edit_name" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
          <select name="role" id="edit_role" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <option value="user">User</option>
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
          <select name="status" id="edit_status" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Customer (for User role)</label>
          <select name="customer_id" id="edit_customer_id" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <option value="">None</option>
            {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">New Password (leave blank to keep current)</label>
          <input type="password" name="password" id="edit_password" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeEditModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-6 py-2 rounded-lg">Cancel</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg">Update User</button>
      </div>
    </form>
  </div>
</div>

<script>
function editUser(id, username, email, name, role, status, customerId) {
  document.getElementById('editForm').action = "{{ url_for('admin_edit_user', user_id=0) }}".replace('0', id);
  document.getElementById('edit_email').value = email || '';
  document.getElementById('edit_name').value = name || '';
  document.getElementById('edit_role').value = role;
  document.getElementById('edit_status').value = status;
  document.getElementById('edit_customer_id').value = customerId || '';
  document.getElementById('edit_password').value = '';
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEditModal();
  }
});
</script>
{% endblock %}

