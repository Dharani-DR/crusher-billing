{% extends "base.html" %}

{% block title %}Create Invoice - Crusher Billing System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-plus-circle"></i> Create New Invoice</h2>
        <hr>
    </div>
</div>

<form method="POST" action="{{ url_for('create_invoice') }}" id="invoiceForm">
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-person"></i> Customer Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" name="customer_name" id="customer_name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Address</label>
                        <textarea class="form-control" name="customer_address" id="customer_address" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-calculator"></i> Invoice Summary</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Subtotal:</strong></td>
                            <td class="text-end"><strong id="subtotal">₹0.00</strong></td>
                        </tr>
                        <tr>
                            <td>CGST (2.5%):</td>
                            <td class="text-end" id="cgst">₹0.00</td>
                        </tr>
                        <tr>
                            <td>SGST (2.5%):</td>
                            <td class="text-end" id="sgst">₹0.00</td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>Grand Total:</strong></td>
                            <td class="text-end"><strong id="grandTotal">₹0.00</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-list"></i> Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Price (₹)</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>GST</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Add Item</label>
                        <div class="input-group">
                            <select class="form-select" id="itemSelect">
                                <option value="">Select an item...</option>
                                {% for item in items %}
                                <option value="{{ item.id }}" 
                                        data-name="{{ item.name }}" 
                                        data-price="{{ item.price }}"
                                        data-gst-rate="{{ item.gst_rate }}"
                                        data-gst-type="{{ item.gst_type }}">
                                    {{ item.name }} ({{ item.name_english or '' }}) - ₹{{ item.price }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-primary" id="addItemBtn">
                                <i class="bi bi-plus"></i> Add Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-check-circle"></i> Create Invoice
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let invoiceItems = [];
let itemCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.getElementById('itemSelect');
    const addItemBtn = document.getElementById('addItemBtn');
    const itemsTableBody = document.getElementById('itemsTableBody');
    
    addItemBtn.addEventListener('click', function() {
        const selectedOption = itemSelect.options[itemSelect.selectedIndex];
        if (!selectedOption.value) return;
        
        const itemId = selectedOption.value;
        const itemName = selectedOption.dataset.name;
        const itemPrice = parseFloat(selectedOption.dataset.price);
        const gstRate = parseFloat(selectedOption.dataset.gstRate);
        const gstType = selectedOption.dataset.gstType;
        
        // Check if item already added
        if (invoiceItems.find(item => item.itemId === itemId)) {
            alert('Item already added. Please update quantity.');
            return;
        }
        
        const item = {
            id: itemCounter++,
            itemId: itemId,
            name: itemName,
            price: itemPrice,
            quantity: 1,
            gstRate: gstRate,
            gstType: gstType
        };
        
        invoiceItems.push(item);
        addItemToTable(item);
        updateTotals();
        
        // Reset select
        itemSelect.selectedIndex = 0;
    });
    
    function addItemToTable(item) {
        const row = document.createElement('tr');
        row.id = `item-row-${item.id}`;
        row.innerHTML = `
            <td>${item.name}</td>
            <td>₹${item.price.toFixed(2)}</td>
            <td>
                <input type="number" step="0.01" min="0.01" class="form-control form-control-sm quantity-input" 
                       value="${item.quantity}" data-item-id="${item.id}" style="width: 100px;">
            </td>
            <td class="amount-cell">₹${(item.price * item.quantity).toFixed(2)}</td>
            <td>${item.gstRate}%</td>
            <td class="total-cell">₹${calculateItemTotal(item).toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger remove-item-btn" data-item-id="${item.id}">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        itemsTableBody.appendChild(row);
        
        // Add event listeners
        row.querySelector('.quantity-input').addEventListener('input', function() {
            const itemId = parseInt(this.dataset.itemId);
            const item = invoiceItems.find(i => i.id === itemId);
            if (item) {
                item.quantity = parseFloat(this.value) || 0;
                updateItemRow(item);
                updateTotals();
            }
        });
        
        row.querySelector('.remove-item-btn').addEventListener('click', function() {
            const itemId = parseInt(this.dataset.itemId);
            invoiceItems = invoiceItems.filter(i => i.id !== itemId);
            row.remove();
            updateTotals();
        });
    }
    
    function calculateItemTotal(item) {
        const subtotal = item.price * item.quantity;
        const gstAmount = subtotal * (item.gstRate / 100);
        return subtotal + gstAmount;
    }
    
    function updateItemRow(item) {
        const row = document.getElementById(`item-row-${item.id}`);
        if (row) {
            row.querySelector('.amount-cell').textContent = `₹${(item.price * item.quantity).toFixed(2)}`;
            row.querySelector('.total-cell').textContent = `₹${calculateItemTotal(item).toFixed(2)}`;
        }
    }
    
    function updateTotals() {
        let subtotal = 0;
        let cgstTotal = 0;
        let sgstTotal = 0;
        
        invoiceItems.forEach(item => {
            const itemSubtotal = item.price * item.quantity;
            subtotal += itemSubtotal;
            
            if (item.gstType === 'standard') {
                const cgstRate = item.gstRate / 2;
                const sgstRate = item.gstRate / 2;
                cgstTotal += itemSubtotal * (cgstRate / 100);
                sgstTotal += itemSubtotal * (sgstRate / 100);
            }
        });
        
        const grandTotal = subtotal + cgstTotal + sgstTotal;
        
        document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('cgst').textContent = `₹${cgstTotal.toFixed(2)}`;
        document.getElementById('sgst').textContent = `₹${sgstTotal.toFixed(2)}`;
        document.getElementById('grandTotal').textContent = `₹${grandTotal.toFixed(2)}`;
    }
    
    // Form submission
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        if (invoiceItems.length === 0) {
            e.preventDefault();
            alert('Please add at least one item to the invoice.');
            return false;
        }
        
        // Add hidden inputs for items
        invoiceItems.forEach(item => {
            const itemIdInput = document.createElement('input');
            itemIdInput.type = 'hidden';
            itemIdInput.name = 'item_id[]';
            itemIdInput.value = item.itemId;
            this.appendChild(itemIdInput);
            
            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden';
            quantityInput.name = 'quantity[]';
            quantityInput.value = item.quantity;
            this.appendChild(quantityInput);
        });
    });
});
</script>
{% endblock %}

